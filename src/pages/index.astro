---
const apiUrl = "https://cfg_googledata.it-e3f.workers.dev/?sheet=1Ef7n23TnmRFfpdzp4D24v0kKDrBxGQnhUPI6CNOASU4&f=A3SD21";

let metaTitle = "Catalogo libri";
let metaDesc = "Catalogo libri disponibili";

let headers = [];
let rows = [];

try {
  const res = await fetch(apiUrl);
  const data = await res.json();
  headers = data.values[0];
  rows = data.values.slice(1);

  if (rows.length > 0) {
    const titoloIdx = headers.indexOf("titolo");
    const autoreIdx = headers.indexOf("autore");
    const abstractIdx = headers.indexOf("abstract");

    metaTitle = `Catalogo: ${rows[0][titoloIdx]} di ${rows[0][autoreIdx]}`;
    metaDesc = rows[0][abstractIdx] || "Catalogo libri disponibili";
  }
} catch (err) {
  console.error("Errore nel fetch:", err);
}
---

<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <title>{metaTitle}</title>
    <meta name="description" content={metaDesc} />
    <meta property="og:title" content={metaTitle} />
    <meta property="og:description" content={metaDesc} />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- DataTables Vanilla CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/v/bs5/dt-2.0.3/datatables.min.css"/>
  </head>
  <body class="container mt-5">
    <h1>{metaTitle}</h1>
    <p>{metaDesc}</p>

    <table id="sheetTable" class="table table-striped">
      <thead>
        <tr>
          {headers.map(h => <th>{h}</th>)}
        </tr>
      </thead>
      <tbody>
        {rows.map(r => (
          <tr>
            {r.map((val, idx) => (
              <td>
                {headers[idx] === "copertina" || headers[idx] === "cdn"
                  ? <img src={val} style="max-width:80px;" />
                  : val}
              </td>
            ))}
          </tr>
        ))}
      </tbody>
    </table>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- DataTables Vanilla JS -->
    <script src="https://cdn.datatables.net/v/bs5/dt-2.0.3/datatables.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function() {
        new DataTable('#sheetTable', {
          pageLength: 10,
          lengthMenu: [10, 25, 50, 100]
        });
      });
    </script>
  </body>
</html>
