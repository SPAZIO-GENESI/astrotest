---
const apiUrl = "https://cfg_googledata.it-e3f.workers.dev/?sheet=1Ef7n23TnmRFfpdzp4D24v0kKDrBxGQnhUPI6CNOASU4&f=A3SD21";

let metaTitle = "Catalogo libri";
let metaDesc = "Catalogo libri disponibili";
let headers = [];
let rows = [];

try {
  const res = await fetch(apiUrl);
  const data = await res.json();
  headers = data.values?.[0] ?? [];
  rows = (data.values ?? []).slice(1);

  if (rows.length > 0 && headers.length > 0) {
    const titoloIdx = headers.indexOf("titolo");
    const autoreIdx = headers.indexOf("autore");
    const abstractIdx = headers.indexOf("abstract");
    const titolo = titoloIdx >= 0 ? rows[0][titoloIdx] : undefined;
    const autore = autoreIdx >= 0 ? rows[0][autoreIdx] : undefined;
    const abstract = abstractIdx >= 0 ? rows[0][abstractIdx] : undefined;

    metaTitle = titolo && autore ? `Catalogo: ${titolo} di ${autore}` : metaTitle;
    metaDesc = abstract || metaDesc;
  }

  // ðŸ”§ FIX: normalizza le righe per evitare errori `.find()`
  rows = rows.map((r) => {
    if (r.length < headers.length) {
      return [...r, ...Array(headers.length - r.length).fill("â€”")];
    }
    return r;
  });

} catch (err) {
  console.error("Errore nel fetch (build):", err);
}
---
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <title>{metaTitle}</title>
    <meta name="description" content={metaDesc} />

    <!-- Bootstrap 5 -->
    <link crossorigin="anonymous" href="/libs/bootstrap.min.css" rel="stylesheet"/>
    
    <!-- Simple-DataTables -->
    <link crossorigin="anonymous" href="/libs/style.css" rel="stylesheet"/>

    <!-- ðŸ”§ CSS migliorato -->
    <style>
      body { background:#f8f9fa; }
      table img { max-width: 80px; border-radius: 4px; }
      table tbody tr:hover { background-color: #f1f1f1; }
      table thead th { background:#343a40; color:white; text-transform:capitalize; }
    </style>
  </head>
  <body class="container py-4">
    <h1 class="text-center mb-4">{metaTitle}</h1>
    <p class="text-muted">{metaDesc}</p>

    <table id="sheetTable" class="table table-striped table-bordered table-sm">
      <thead>
        <tr>{headers.map((h) => <th>{h}</th>)}</tr>
      </thead>
      <tbody>
        {rows.map((r) => (
          <tr>
            {r.map((val, idx) => {
              const safeVal = val || "â€”";
              return (
                <td>
                  {["copertina", "cdn"].includes(headers[idx])
                    ? <img src={safeVal} alt="copertina" />
                    : safeVal}
                </td>
              );
            })}
          </tr>
        ))}
      </tbody>
    </table>

    <!-- JS -->
    <script src="/libs/simple-datatables.js" defer></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const table = document.querySelector("#sheetTable");
        if (!table) return;

        new simpleDatatables.DataTable(table, {
          perPage: 10,
          perPageSelect: [10, 25, 50, 100],
          searchable: true,
          pagination: true
        });
      });
    </script>
  </body>
</html>
