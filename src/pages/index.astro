---
const apiUrl = "https://cfg_googledata.it-e3f.workers.dev/?sheet=1Ef7n23TnmRFfpdzp4D24v0kKDrBxGQnhUPI6CNOASU4&f=A3SD21";

let metaTitle = "Catalogo libri";
let metaDesc = "Catalogo libri disponibili";
let headers = [];
let rows = [];

try {
  const res = await fetch(apiUrl);
  const data = await res.json();
  headers = data.values?.[0] ?? [];
  rows = (data.values ?? []).slice(1);

  if (rows.length > 0 && headers.length > 0) {
    const titoloIdx = headers.indexOf("titolo");
    const autoreIdx = headers.indexOf("autore");
    const abstractIdx = headers.indexOf("abstract");
    const titolo = titoloIdx >= 0 ? rows[0][titoloIdx] : undefined;
    const autore = autoreIdx >= 0 ? rows[0][autoreIdx] : undefined;
    const abstract = abstractIdx >= 0 ? rows[0][abstractIdx] : undefined;

    metaTitle = titolo && autore ? `Catalogo: ${titolo} di ${autore}` : metaTitle;
    metaDesc = abstract || metaDesc;
  }
} catch (err) {
  console.error("Errore nel fetch (build):", err);
}
---

<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <title>{metaTitle}</title>
    <meta name="description" content={metaDesc} />
    <meta property="og:title" content={metaTitle} />
    <meta property="og:description" content={metaDesc} />

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- DataTables Vanilla 2.x (no jQuery) CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/v/bs5/dt-2.0.3/datatables.min.css"/>
  </head>
  <body class="container py-4">
    <header class="mb-4">
      <h1 class="h3">{metaTitle}</h1>
      <p class="text-muted">{metaDesc}</p>
    </header>

    <main>
      <table id="sheetTable" class="table table-striped table-bordered">
        <thead>
          <tr>
            {headers.map((h) => <th>{h}</th>)}
          </tr>
        </thead>
        <tbody>
          {rows.map((r) => (
            <tr>
              {r.map((val, idx) => (
                <td>
                  {headers[idx] === "copertina" || headers[idx] === "cdn"
                    ? <img src={val} alt="copertina" style="max-width:80px; height:auto;" />
                    : val}
                </td>
              ))}
            </tr>
          ))}
        </tbody>
      </table>
    </main>

    <!-- Bootstrap 5 JS (bundle, no jQuery) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>

    <!-- DataTables Vanilla 2.x (no jQuery) JS -->
    <script src="https://cdn.datatables.net/v/bs5/dt-2.0.3/datatables.min.js" defer></script>

    <!-- Inizializzazione DataTables Vanilla -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Assicurati che non ci siano altri script che caricano jQuery o la versione jQuery di DataTables
        if (typeof DataTable === "undefined") {
          console.error("DataTable non trovato: controlla che non stai includendo la versione jQuery di DataTables altrove.");
          return;
        }

        new DataTable("#sheetTable", {
          pageLength: 10,
          lengthMenu: [10, 25, 50, 100],
          layout: {
            topStart: "search",
            topEnd: "pageLength",
            bottomStart: "info",
            bottomEnd: "paging"
          }
        });
      });
    </script>
  </body>
</html>
