---
const apiUrl = "https://cfg_googledata.it-e3f.workers.dev/?sheet=1Ef7n23TnmRFfpdzp4D24v0kKDrBxGQnhUPI6CNOASU4&f=A3SD21";

let metaTitle = "Catalogo libri";
let metaDesc = "Catalogo libri disponibili";
let headers = [];
let rows = [];

try {
  const res = await fetch(apiUrl);
  const data = await res.json();
  headers = data.values?.[0] ?? [];
  rows = (data.values ?? []).slice(1);

  if (rows.length > 0 && headers.length > 0) {
    const titoloIdx = headers.indexOf("titolo");
    const autoreIdx = headers.indexOf("autore");
    const abstractIdx = headers.indexOf("abstract");
    const titolo = titoloIdx >= 0 ? rows[0][titoloIdx] : undefined;
    const autore = autoreIdx >= 0 ? rows[0][autoreIdx] : undefined;
    const abstract = abstractIdx >= 0 ? rows[0][abstractIdx] : undefined;

    metaTitle = titolo && autore ? `Catalogo: ${titolo} di ${autore}` : metaTitle;
    metaDesc = abstract || metaDesc;
  }

  // ðŸ”§ FIX: normalizza le righe per evitare errori `.find()`
  rows = rows.map((r) => {
    if (r.length < headers.length) {
      return [...r, ...Array(headers.length - r.length).fill("â€”")];
    }
    return r;
  });

} catch (err) {
  console.error("Errore nel fetch (build):", err);
}
---
