---
const sheetId = '1Ef7n23TnmRFfpdzp4D24v0kKDrBxGQnhUPI6CNOASU4';
const apiUrl = `https://cfg_googledata.it-e3f.workers.dev/?sheet=${sheetId}&f=A3SD21`;

let rows = [];

try {
  const res = await fetch(apiUrl);
  rows = await res.json();
} catch (err) {
  console.error("Errore nel fetch dei dati:", err);
}

// Meta dinamici con fallback
const metaTitle = rows.length > 0 ? `Tabella: ${rows[0].Nome ?? 'Record'}` : "Tabella Dati";
const metaDesc = `Visualizza ${rows.length} record dal Google Sheet in tabella interattiva.`;
---

<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <title>{metaTitle}</title>
    <meta name="description" content={metaDesc} />
    <meta property="og:title" content={metaTitle} />
    <meta property="og:description" content={metaDesc} />

    <!-- Bootstrap CSS -->
    <link 
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" 
      rel="stylesheet"
    />
    <!-- DataTables CSS -->
    <link 
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" 
      rel="stylesheet"
    />
  </head>
  <body class="container mt-5">
    <h1>{metaTitle}</h1>

    {rows.length > 0 ? (
      <table id="sheetTable" class="table table-striped">
        <thead>
          <tr>
            {Object.keys(rows[0]).map(key => (
              <th>{key}</th>
            ))}
          </tr>
        </thead>
        <tbody>
          {rows.map((row) => (
            <tr>
              {Object.values(row).map((val) => (
                <td>{val}</td>
              ))}
            </tr>
          ))}
        </tbody>
      </table>
    ) : (
      <p>Nessun dato disponibile</p>
    )}

    <!-- jQuery + DataTables + Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function() {
        $('#sheetTable').DataTable();
      });
    </script>
  </body>
</html>
